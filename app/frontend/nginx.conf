events {}

http {
  limit_req_zone $binary_remote_addr zone=req_limit:10m rate=10r/m;

  server {
    listen 80;
    server_name onegat.es www.onegat.es backend.laroda.onegat.es laroda.onegat.es backend.prueba.onegat.es prueba.onegat.es;

    # ‚úÖ Acceso a Swagger (solo si SHOW_DOCS=true en backend)
    location ~ ^/(docs|redoc|openapi\.json)$ {
      proxy_pass http://backend:8000;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # üö´ BLOQUEO TOTAL a cualquier ruta de registro
    location ~* ^/(auth|api/auth)?/register/?$ {
      deny all;
      return 403;
    }

    # üîê Protecci√≥n fuerte del endpoint de subida de archivos
    location /uploads/ {
      # Desactiva SVGs
      location ~* \.svg$ {
        return 403;
      }

      # Cabeceras para mitigar XSS
      add_header Content-Security-Policy "default-src 'none'; sandbox";
      add_header X-Content-Type-Options "nosniff";
      add_header Content-Disposition "attachment";

      proxy_pass http://backend:8000;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # üîí Permitir solo la red interna acceder a /api
    location /api/ {
      allow 172.17.0.0/16;
      deny all;
      proxy_pass http://backend:8000;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # üñ•Ô∏è Frontend
    location / {
      proxy_pass http://frontend:3000/preview;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';
      proxy_cache_bypass $http_upgrade;
    }

    # üõ°Ô∏è Cabeceras de seguridad globales
    add_header X-Content-Type-Options "nosniff";
    add_header X-Frame-Options "DENY";
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "no-referrer-when-downgrade";
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()";
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;
  }
}